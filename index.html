<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SC Ready Practice Test</title>
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 2. Use a clean, modern font (Changed to Poppins) */
        body {
            font-family: 'Poppins', sans-serif;
        }
        /* Added for the Poppins font */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap');

        /* 3. Added Pop-in Animation */
        @keyframes pop-in {
            0% {
                transform: scale(0.95);
                opacity: 0;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .pop-in {
            /* Animation applied by JavaScript */
            animation: pop-in 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        /* 4. Added Loading Spinner */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            width: 2.5rem;
            height: 2.5rem;
            animation: spin 1s linear infinite;
        }
        .loader-gray {
            border-top-color: #4b5563; /* gray-600 */
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- ====================================================== -->
    <!-- == SCREEN 1: LOGIN (New) == -->
    <!-- ====================================================== -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4 md:p-8">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-10 text-center pop-in">
            <h1 class="text-3xl font-bold text-slate-800">
                SC Ready Practice Test ‚úèÔ∏è
            </h1>
            <p class="text-lg text-slate-500 mt-3">
                Please sign in with your account to continue.
            </p>
            
            <!-- New Email/Password Form -->
            <form id="login-form" class="mt-8 space-y-4">
                <div>
                    <input id="login-email" type="email" placeholder="Email" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <input id="login-password" type="password" placeholder="Password" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <button type="submit" id="login-btn" class="w-full flex items-center justify-center gap-3 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-xl shadow-md transition-all duration-300 transform hover:scale-105">
                    Sign In
                </button>
            </form>
            
            <!-- Error messages will appear here -->
            <p id="login-message" class="text-red-500 mt-4 h-6"></p>
        </div>
    </div>


    <!-- ====================================================== -->
    <!-- == SCREEN 2: MAIN CONTENT (Hidden by default) == -->
    <!-- ====================================================== -->
    <div id="main-content" class="min-h-screen flex items-center justify-center p-4 md:p-8 hidden">

        <!-- Main Content Card (Softer corners and shadow) -->
        <div class="w-full max-w-5xl bg-white rounded-2xl shadow-xl p-6 md:p-10 relative overflow-hidden">

            <!-- New Sign Out Button -->
            <button id="logout-btn" class="absolute top-4 right-4 md:top-6 md:right-6 bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-xl transition-all hover:bg-slate-300">
                Sign Out
            </button>

            <!-- ====================================================== -->
            <!-- == HOME SCREEN (Grade Selection) == -->
            <!-- ====================================================== -->
            <div id="home-screen">
                <header class="text-center animatable">
                    <h1 class="text-3xl md:text-5xl font-bold text-slate-800">
                        SC Ready Practice Test ‚úèÔ∏è
                    </h1>
                    <p class="text-lg md:text-xl text-slate-500 mt-3">
                        Please select a grade level to begin.
                    </I>
                </header>

                <!-- Grade Selection Grid -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8 mt-10 md:mt-12 animatable">
                    
                    <!-- Box 1: 3rd Grade (Button) - New Color, Corners, Emoji -->
                    <button 
                        data-grade="3rd Grade" 
                        data-path="3rd"
                        class="grade-btn text-white p-8 md:p-10 rounded-2xl shadow-md font-bold text-2xl md:text-3xl transition-all duration-300 ease-in-out transform hover:scale-105 hover:shadow-lg bg-blue-500 hover:bg-blue-600">
                        3rd Grade ü•â
                    </button>

                    <!-- Box 2: 4th Grade (Button) - New Color, Corners, Emoji -->
                    <button 
                        data-grade="4th Grade" 
                        data-path="4th"
                        class="grade-btn text-white p-8 md:p-10 rounded-2xl shadow-md font-bold text-2xl md:text-3xl transition-all duration-300 ease-in-out transform hover:scale-105 hover:shadow-lg bg-yellow-500 hover:bg-yellow-600">
                        4th Grade ü•à
                    </button>

                    <!-- Box 3: 5th Grade (Button) - New Color, Corners, Emoji -->
                    <button 
                        data-grade="5th Grade" 
                        data-path="5th"
                        class="grade-btn text-white p-8 md:p-10 rounded-2xl shadow-md font-bold text-2xl md:text-3xl transition-all duration-300 ease-in-out transform hover:scale-105 hover:shadow-lg bg-green-500 hover:bg-green-600">
                        5th Grade ü•á
                    </button>

                    <!-- Box 4: 6th Grade (Button) - New Color, Corners, Emoji -->
                    <button 
                        data-grade="6th Grade" 
                        data-path="6th"
                        class="grade-btn text-white p-8 md:p-10 rounded-2xl shadow-md font-bold text-2xl md:text-3xl transition-all duration-300 ease-in-out transform hover:scale-105 hover:shadow-lg bg-red-500 hover:bg-red-600">
                        6th Grade üéì
                    </button>

                    <!-- Box 5: 4th Grade Science (Direct Link) - New Color, Corners, Emoji -->
                    <a 
                        id="science-link"
                        href="#" 
                        target="_blank" 
                        rel="noopener noreferrer"
                        class="flex items-center justify-center text-center text-white p-8 md:p-10 rounded-2xl shadow-md font-bold text-2xl md:text-3xl transition-all duration-300 ease-in-out transform hover:scale-105 hover:shadow-lg bg-purple-500 hover:bg-purple-600 sm:col-span-1">
                        4th Grade Science üß™
                    </a>
                </div>
            </div>

            <!-- ====================================================== -->
            <!-- == SUBJECT SCREEN (ELA / Math Selection) == -->
            <!-- ====================================================== -->
            <div id="subject-screen" class="hidden">
                
                <!-- Back Button (Softer corners) - Renamed id -->
                <button id="back-to-grades-btn" class="absolute top-4 left-4 md:top-6 md:left-6 bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-xl transition-all hover:bg-slate-300">
                    &larr; Back
                </button>

                <header class="text-center mt-12 md:mt-0 animatable">
                    <!-- Title will be set by JavaScript -->
                    <h1 id="subject-title" class="text-3xl md:text-5xl font-bold text-slate-800">
                        <!-- e.g., 3rd Grade -->
                    </h1>
                    <p class="text-lg md:text-xl text-slate-500 mt-3">
                        Please select a subject.
                    </p>
                </header>

                <!-- Subject Selection Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-10 mt-10 md:mt-12 animatable">
                    
                    <!-- Box 1: ELA (Changed to Button) -->
                    <button 
                        id="ela-btn"
                        data-subject="ELA"
                        class="flex items-center justify-center text-center text-white p-16 md:p-24 rounded-2xl shadow-md font-bold text-4xl transition-all duration-300 ease-in-out transform hover:scale-105 hover:shadow-lg bg-sky-500 hover:bg-sky-600">
                        ELA üìö
                    </button>
                    
                    <!-- Box 2: Mathematics (Changed to Button) -->
                    <button 
                        id="math-btn"
                        data-subject="Mathematics"
                        class="flex items-center justify-center text-center text-white p-16 md:p-24 rounded-2xl shadow-md font-bold text-4xl transition-all duration-300 ease-in-out transform hover:scale-105 hover:shadow-lg bg-orange-500 hover:bg-orange-600">
                        Mathematics üßÆ
                    </button>
                </div>
            </div>

            <!-- ====================================================== -->
            <!-- == NEW SCREEN 3: TEST SELECTION == -->
            <!-- ====================================================== -->
            <div id="test-selection-screen" class="hidden">
                
                <!-- Back Button -->
                <button id="back-to-subjects-btn" class="absolute top-4 left-4 md:top-6 md:left-6 bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-xl transition-all hover:bg-slate-300">
                    &larr; Back
                </button>

                <header class="text-center mt-12 md:mt-0 animatable">
                    <!-- Title will be set by JavaScript -->
                    <h1 id="test-title" class="text-3xl md:text-5xl font-bold text-slate-800">
                        <!-- e.g., 3rd Grade - ELA -->
                    </h1>
                    <p id="test-subtitle" class="text-lg md:text-xl text-slate-500 mt-3">
                        Please select a test.
                    </p>
                </header>

                <!-- Loading Spinner -->
                <div id="loading-spinner" class="mt-12 flex justify-center items-center h-40">
                    <div class="loader loader-gray"></div>
                    <p class="ml-4 text-slate-600 text-lg">Loading Tests...</p>
                </div>

                <!-- Test Selection Grid (Dynamic Content) -->
                <!-- This grid will be 2, 3, or 4 columns based on screen size -->
                <div id="test-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8 mt-10 md:mt-12 animatable">
                    <!-- Test boxes will be generated by JavaScript and inserted here -->
                    <!-- 
                    Example of a generated box:
                    <a href="..." target="_blank" class="text-white p-6 rounded-2xl shadow-md font-bold text-xl transition-all ... bg-gray-600 hover:bg-gray-700">
                        Test 1: Reading
                    </a> 
                    -->
                </div>
                <p id="error-message" class="text-center text-red-500 mt-8 text-lg"></p>
            </div>

        </div>
    </div>


    <!-- 3. JavaScript for Navigation AND AUTHENTICATION -->
    
    <!-- Import Firebase SDKs -->
    <script type="module">
        // Import functions from the Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        // Import analytics
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-analytics.js";
        // Import only the auth functions we need
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        // We no longer need Firestore for authorization
        // import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // --- 1. FIREBASE CONFIGURATION ---
        // !! IMPORTANT !!
        // Paste your `firebaseConfig` object from Step 1 here
        const firebaseConfig = {
            apiKey: "AIzaSyBfvwMOWXRqN1QmFVoHJZo2mWvnrQMxm1k",
            authDomain: "scready-f7bc9.firebaseapp.com",
            projectId: "scready-f7bc9",
            storageBucket: "scready-f7bc9.appspot.com",
            messagingSenderId: "94383995704",
            appId: "1:94383995704:web:3a16a7cd3e74fabf34dfcd",
            measurementId: "G-CH5SBDKBEL"
        };

        // --- 2. GITHUB REPO CONFIGURATION ---
        // !! IMPORTANT !!
        // Replace this with the URL of your GitHub repository
        const GITHUB_REPO_URL = "https://github.com/YOUR_USERNAME/YOUR_REPO_NAME";
        
        // You probably won't need to change this (main is the default branch)
        const GITHUB_BRANCH = "main";
        
        // --- Parsed from URL ---
        let GITHUB_OWNER = 'YOUR_USERNAME';
        let GITHUB_REPO = 'YOUR_REPO_NAME';
        try {
            const urlParts = new URL(GITHUB_REPO_URL);
            const pathParts = urlParts.pathname.split('/').filter(Boolean); // filter(Boolean) removes empty strings
            if (pathParts.length >= 2) {
                GITHUB_OWNER = pathParts[0];
                GITHUB_REPO = pathParts[1];
            }
        } catch (e) {
            console.error("Could not parse GITHUB_REPO_URL. Please ensure it's a valid URL.");
        }
        
        // Base URL for the GitHub API
        const GITHUB_API_URL = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents`;
        // --- END CONFIGURATION ---

        
        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        // We no longer need the database for this
        // const db = getFirestore(app);

        
        // --- Get UI Elements ---
        const loginScreen = document.getElementById('login-screen');
        const mainContent = document.getElementById('main-content');
        
        // Updated to get the new form elements
        const loginForm = document.getElementById('login-form');
        const loginEmail = document.getElementById('login-email');
        const loginPassword = document.getElementById('login-password');
        
        const logoutBtn = document.getElementById('logout-btn');
        const loginMessage = document.getElementById('login-message');

        const baseRepoUrl = `${GITHUB_REPO_URL}/tree/${GITHUB_BRANCH}`;
        const homeScreen = document.getElementById('home-screen');
        const subjectScreen = document.getElementById('subject-screen');
        const gradeButtons = document.querySelectorAll('.grade-btn');
        const scienceLink = document.getElementById('science-link');
        const backBtn = document.getElementById('back-to-grades-btn');
        const subjectTitle = document.getElementById('subject-title');
        
        // Changed links to buttons
        const elaBtn = document.getElementById('ela-btn');
        const mathBtn = document.getElementById('math-btn');

        // New Test Screen Elements
        const testSelectionScreen = document.getElementById('test-selection-screen');
        const backToSubjectsBtn = document.getElementById('back-to-subjects-btn');
        const testTitle = document.getElementById('test-title');
        const testSubtitle = document.getElementById('test-subtitle');
        const loadingSpinner = document.getElementById('loading-spinner');
        const testGrid = document.getElementById('test-grid');
        const errorMessage = document.getElementById('error-message');
        
        // Animation collections
        const homeAnimatables = homeScreen.querySelectorAll('.animatable');
        const subjectAnimatables = subjectScreen.querySelectorAll('.animatable');
        const testAnimatables = testSelectionScreen.querySelectorAll('.animatable');

        // --- Global State Variables ---
        let currentGrade = '';
        let currentGradePath = '';

        
        // --- 4. AUTHENTICATION LOGIC ---

        // Listen for Login form submission
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault(); // Stop the form from reloading the page
            
            const email = loginEmail.value;
            const password = loginPassword.value;
            loginMessage.textContent = "Signing in...";

            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    // Signed in
                    const user = userCredential.user;
                    // No need to check authorization, Firebase did it
                    loginMessage.textContent = "";
                })
                .catch((error) => {
                    // Handle Errors here.
                    console.error("Sign-in error", error.code);
                    if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                        loginMessage.textContent = "Invalid email or password.";
                    } else {
                        loginMessage.textContent = "Sign-in failed. Please try again.";
                    }
                });
        });

        // Listen for Logout button click
        logoutBtn.addEventListener('click', () => {
            signOut(auth);
        });

        // Main auth state listener
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in
                // We no longer need to check Firestore
                showMainContent();
            } else {
                // User is signed out
                showLoginScreen();
            }
        });

        /**
         * Checks if the signed-in user's email is in the 'allowedUsers' list.
         * THIS FUNCTION IS NO LONGER NEEDED
         */
        /*
        async function checkUserAuthorization(user) {
            loginMessage.textContent = "Checking authorization...";
            
            // Get the user's email
            const userEmail = user.email;

            // Create a reference to the document in Firestore
            // The document ID is the user's email
            const docRef = doc(db, "allowedUsers", userEmail);
            
            try {
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    // SUCCESS: User is on the list
                    showMainContent();
                } else {
                    // FAILURE: User is not on thelist
                    loginMessage.textContent = "Sorry, you are not authorized.";
                    // Sign them out automatically
                    signOut(auth);
                }
            } catch (error) {
                console.error("Error checking authorization:", error);
                loginMessage.textContent = "Error checking authorization.";
                signOut(auth);
            }
        }
        */

        /**
         * Hides the main content and shows the login screen
         */
        function showLoginScreen() {
            mainContent.classList.add('hidden');
            loginScreen.classList.remove('hidden');
        }

        /**
         * Hides the login screen and shows the main content
         */
        function showMainContent() {
            loginScreen.classList.add('hidden');
            mainContent.classList.remove('hidden');
            
            // Trigger the pop-in animation for the home screen
            homeAnimatables.forEach(el => el.classList.add('pop-in'));
            
            // Make sure the subject screen is hidden
            showGradeScreen();
        }

        
        // --- 5. NAVIGATION LOGIC ---
        
        /**
         * Shows the Test Selection Screen
         * Fetches tests from GitHub
         */
        async function showTestScreen(event) {
            const subject = event.currentTarget.dataset.subject;
            
            // e.g., "3rd Grade - ELA"
            testTitle.textContent = `${currentGrade} - ${subject}`;
            testSubtitle.textContent = "Please select a test.";
            errorMessage.textContent = ""; // Clear old errors
            
            // Clear old tests and show loading spinner
            testGrid.innerHTML = '';
            loadingSpinner.classList.remove('hidden');

            // Hide subjects, show tests
            animateScreenTransition(subjectScreen, testSelectionScreen);
            
            // Build the final path, e.g., "3rd/ELA" or "3rd/Mathematics"
            const dataPath = `${currentGradePath}/${subject}`;
            const apiUrl = `${GITHUB_API_URL}/${dataPath}?ref=${GITHUB_BRANCH}`;

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error(`Folder not found (404). Check your repo structure.`);
                }
                const items = await response.json();
                
                // Filter for files and directories only (removes submodules, etc.)
                const tests = items.filter(item => item.type === 'file' || item.type === 'dir');

                if (tests.length === 0) {
                    testSubtitle.textContent = "No tests found in this folder.";
                } else {
                    // Populate the grid with test boxes
                    tests.forEach(item => {
                        const testBox = document.createElement('a');
                        testBox.href = item.html_url; // Links to the GitHub file/folder
                        testBox.target = "_blank";
                        testBox.rel = "noopener noreferrer";
                        // Clean up the name (e.g., "Test_1.html" -> "Test 1")
                        const displayName = item.name.replace(/_/g, ' ').replace(/\.html$|\.md$/i, '');
                        
                        testBox.textContent = displayName;
                        testBox.className = "flex items-center justify-center text-center text-white p-8 rounded-2xl shadow-md font-bold text-xl transition-all duration-300 ease-in-out transform hover:scale-105 hover:shadow-lg bg-slate-600 hover:bg-slate-700";
                        testGrid.appendChild(testBox);
                    });
                }

            } catch (error) {
                console.error("Error fetching GitHub tests:", error);
                errorMessage.textContent = `Error loading tests. (${error.message})`;
            } finally {
                // Hide spinner regardless of outcome
                loadingSpinner.classList.add('hidden');
            }
        }

        /**
         * Shows the Subject Selection Screen
         */
        function showSubjectScreen(event) {
            currentGrade = event.currentTarget.dataset.grade; 
            currentGradePath = event.currentTarget.dataset.path;   

            subjectTitle.textContent = currentGrade;
            
            // We no longer set hrefs, we just show the screen
            // elaLink.href = `${baseRepoUrl}/${path}/ELA`;
            // mathLink.href = `${baseRepoUrl}/${path}/Mathematics`;

            animateScreenTransition(homeScreen, subjectScreen);
        }

        /**
         * Shows the Grade Selection Screen (Home)
         */
        function showGradeScreen() {
            // This can be called from either the Subject screen or Test screen
            animateScreenTransition(subjectScreen, homeScreen);
            animateScreenTransition(testSelectionScreen, homeScreen); // Ensures it works from test screen too
        }

        /**
         * Shows the Subject Screen when coming from the Test Screen
         */
        function showSubjectScreenFromTests() {
            animateScreenTransition(testSelectionScreen, subjectScreen);
        }
        
        /**
         * Helper function to manage animations and visibility
         */
        function animateScreenTransition(screenToHide, screenToShow) {
            // Only run if the screen isn't already visible
            if (screenToShow.classList.contains('hidden')) {
                // Find animatable content in the new screen
                const animatables = screenToShow.querySelectorAll('.animatable');
                
                // Reset and trigger animation
                animatables.forEach(el => {
                    el.classList.remove('pop-in'); 
                    void el.offsetWidth; // Force browser reflow
                    el.classList.add('pop-in'); 
                });

                screenToHide.classList.add('hidden');
                screenToShow.classList.remove('hidden');
                window.scrollTo(0, 0);
            }
        }

        // --- 6. EVENT LISTENERS ---

        // Grade buttons navigate to Subject screen
        gradeButtons.forEach(button => {
            button.addEventListener('click', showSubjectScreen);
        });

        // Subject buttons navigate to Test screen
        elaBtn.addEventListener('click', showTestScreen);
        mathBtn.addEventListener('click', showTestScreen);

        // Back buttons
        backBtn.addEventListener('click', showGradeScreen); // back-to-grades-btn
        backToSubjectsBtn.addEventListener('click', showSubjectScreenFromTests);
        
        // Set the direct link for 4th Grade Science
        scienceLink.href = `${baseRepoUrl}/4th Grade Science`;

    </script>

</body>
</html>

